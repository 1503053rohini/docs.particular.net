---
title: NHibernate Custom mapping with hbm.xml, attributes or fluent api
summary: Create a custom mapping to change how NHibernate creates the database schema using different techniques.
tags:
 - NHibernate
 - Mapping
related:
 - nservicebus/nhibernate/accessing-data
---


Sometimes the database schema that gets generated by `NServiceBus.NHibernate` for your saga data types is insufficient. For example, you might need to store strings with a different string length, want so use complex types, need to store DateTime values with a high precision or maybe want to tweak the eager versus lazy loading to improve performance. You will need to create a custom mapping to achieve this so that the generated default mapping will not be used.

Custom mapping options:

* Create a `*.hbm.xml` file for your saga data class
* Use Fluent NHibernate (popular separate fluent api)
* Use NHibernate.Mapping.Attributes
* Loquacious Configuration (native fluent api)

There are probably even other options but these are the most frequently used.

NOTE: **Mention here if it is required to add custom mappings for all sagas**


See [NHibernate configuration](configuration.md) on how you can pass this configuration object to the NServiceBus NHibernate configuration.

NOTE: When you create a custom mapping then you are responsible for mapping the primary key and unique indexes correctly.


NOTE: When using custom mappings you are responsible for creating unique indexes for all mapped saga properties. This is especially important when using both optimistic concurrency and a transaction isolation level different from serializable and allow concurrent processing of messages. Not adding this can result in multiple saga entities be persisted as the second insert will not fail when inserting a duplicate saga key (different from the primary key column) when multiple message  are processed concurrently that target the same saga instance.


## Custom .hbm.xml mapping

Using NHibernate mapping files is the original way to customize your mapping. It needs to be created and then either embedded as a resource in your assembly or available on the file system.

NOTE: Using xml mappings is the default approach for NHibernate.

Look at these pages to see how you can create these mappings:

* [Your first NHibernate based application](http://nhibernate.info/doc/tutorials/first-nh-app/your-first-nhibernate-based-application.html) (nhibernate.info)


### Mappings as embedded resources

It is not required to create your own NHibernate configuration object and pass it to the NServiceBus NHibernate configuration when using embedded resources. All other custom mapping options require the NHibernate configuration to be customized and passed to NServiceBus.


### Read mappings from file system instead of embedded resources

If you do not want to embed the `*.hbm.xml` files then you can also load mappings from the file system. Create a custom NHibernate configuration object and use the following example to add mappings from the file system.

<!-- import NHibernateLoadMappingsFromFileSystem -->

## Use Fluent NHibernate

Fluent NHibernate gives you a type-safe mapping approach where the mapping is specified as c# code and not as xml but still seperate from the classes. The benefit is that you get compile time feedback when a mapping is not valid any more when you have breaking changes in your mapping but also that your classes and mappings are not part of the same .net type.

To use it with NServiceBus:

1. Install `FluentNHibernate` package via Nuget.
2. Create a custom NHibernate configuration
a. via FluentNHibernate
b. or by creating a new Configuration instance and pass it to FluentNHibernate
3. Pass it to the NServiceBus NHibernate configuration.


Example of a possible implementation:

<!-- import NHibernateInitWithFluentNHibernate -->

References:

* [Fluent NHibernate - Website](http://www.fluentnhibernate.org)
* [Fluent NHibernate - Nuget package](http://www.nuget.org/packages/FluentNHibernate/)
* [Fluent NHibernate - GitHub Repository](https://github.com/jagregory/fluent-nhibernate)
* [Fluent NHibernate - Getting Started](https://github.com/jagregory/fluent-nhibernate/wiki/Getting-started)


## Use NHibernate.Mapping.Attributes

With NHibernate.Attributes you can decorate your saga data classes. This keeps your classes, mapping and schema data very close. Your saga types have a dependency on the NHibernate.Attributes assembly.

How NHibernate.Attributes works is that it needs to know which types it needs to scan, then it create a regular NHibernate mapping configuration that gets passed to your NHibernate configuration.

1. Add the nuget package `NHibernate.Mapping.Attributes`
2. Create a custom NHibernate configuration object.
3. Initialite the attribute mapping (see sample below).
4. Pass it to the NServiceBus NHibernate configuration.


Initialize the NHibernate attribute based mappings:

<!-- NHibernateInitWithNHibernateMappingAttributes -->

Take a look at the NHibernate mapping attributes documentation for an example.


References:
* [NHibernate Mapping attributes - Documentation](http://nhibernate.info/doc/nhibernate-reference/mapping-attributes.html)
* [NHibernate Mapping attributes - GitHub repository](https://github.com/nhibernate/NHibernate.Mapping.Attributes)
* [NHibernate Mapping attributes - NuGet package](http://www.nuget.org/packages/NHibernate.Mapping.Attributes/)


## Use the Loquacious API

The Loquacious api is NHibernate its native fluent mapping ability. You declare your mapping in code just like FluentNHibernate but using a different syntax. It can help you create a type-safe configuration but you can also create your custom mappings. The benefit is that this api is already available via the NHibernate package so requires no additional downloads. Its API

To use it:

1. Create a custom NHibernte configuration object.
2. Use either the model mapping or convention mapping features.
3. Pass it to the NServiceBus NHibernate configuration.



References:

* [NHibernate Loquacious API - Howto](http://nhibernate.info/doc/howto/mapping/a-fully-working-skeleton-for-sexy-loquacious-nh.html)
* [NHibernate Loquacious API - Mapping by code](http://fabiomaulo.blogspot.nl/2011/04/nhibernate-32-mapping-by-code.html)
* [NHibernate Loquacious API - Configuration](http://nhibernate.info/blog/2011/01/21/loquacious-configuration-in-nhibernate-3.html)


