---
title: Capture and visualize metrics using Prometheus and Grafana
component: Metrics
---

[Prometheus](https://prometheus.io) is a monitoring solution for storing time series data like metrics. [Grafana](https://grafana.com) allows you to query and visualize the data stored in Prometheus (and other sources). This sample demonstrates how to capture NServiceBus metrics, storing these in Prometheus and visualizing this using Grafana.

![example graph events](example-graph-events.png)

This sample reports the following metrics to Prometheus:

 * Fetched messages per second 
 * Failed messages per second
 * Successful messages per second

 The sample also shows data like `Average message processing time in milliseconds` and `Maximum critical time in milliseconds`. For a detailed explanation of these metrics refer to the [metrics captured section in the metrics documentation](/nservicebus/operations/metrics.md#metrics-captured).


## Prerequisites

To run this sample, download and run both Prometheus and Grafana. This sample uses Prometheus 1.7.1 and Grafana 4.4.2 that both run on Windows.

- https://prometheus.io
- https://grafana.com


## Code overview

The sample simulates messages load with a random 10% failure rate using the `LoadSimulator` class:

snippet: load-simulator


## Use NServiceBus.Metrics to capture metric values

To capture the metric values generated by NServiceBus, a class called `PrometheusFeature` is added to the sample. It is responsible for enabling the NServiceBus metrics feature.

snippet: enable-nsb-metrics


snippet: register-probe


TODO: Name mapping
TODO: Labels



## Prometheus

Prometheus needs to be configured to pull data from the endpoint. They provide a pretty good [getting started guide](https://prometheus.io/docs/introduction/getting_started/). 


### Add a target

 Edit `prometheus.yml` and  add a new target for scraping similar

```
- job_name: 'nservicebus'

    scrape_interval: 5s

    static_configs:
      - targets: ['localhost:3030']
```

### Show a graph

NServiceBus pushes events for *success, failure, and fetched*. These events need to be converted to rates by a query:

    avg(rate(nservicebus_success_total[5m])) 


### Use rules


The mentioned queryis an expensive operation on the database and can be precalculated by configuring rules that calculate rates based on the counters. 

    nservicebus_success_total:avg_rate5m = avg(rate(nservicebus_success_total[5m]))
    nservicebus_failure_total:avg_rate5m = avg(rate(nservicebus_failure_total[5m]))
    nservicebus_fetched_total:avg_rate5m = avg(rate(nservicebus_fetched_total[5m]))


Instead of the query mentioned earlier we can now use the pre calculated query.

    nservicebus_success_total:avg_rate5m


## Grafana


### Datasource

### Dashboard

### 